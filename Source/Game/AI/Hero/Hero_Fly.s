;********************************
; HERO_FLY.S
;********************************
;	Author:	Patrick Meehan
;	(c)2000	Interactive Imagination
;	All rights reserved

;********************************
?HERO_FLY_COLL_CLOSE
	XOR			A
	LD			(COLL_MASK+COLLCODE_SPACE),A
	CPL					
	LD			(COLL_MASK+COLLCODE_JUMP),A

	RET

;********************************
?HERO_FLY_COLL_OPEN
	XOR			A								
	LD			(COLL_MASK+COLLCODE_JUMP),A
	CPL
	LD			(COLL_MASK+COLLCODE_SPACE),A

	RET

;********************************
?HERO_AI_FLY_DOWN_START
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_DOWN_START_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_DOWN_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_DOWN
	CALL		?HERO_AI_OPEN

?HERO_AI_FLY_DOWN_NEXT
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_DOWN_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_DOWN_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_DOWN_STATE
	LD			A,%00000011
	LDFF_A		ACTOR_FLAGS
	CALL		?HERO_AI_OPEN
	CALL		?HERO_FLY_COLL_OPEN

	; CHECK DIRECTION
	;--------------------------------
	LD			A,(AI_CNTDOWN)

	BIT			BitUp,A
	JP			NZ,?HERO_AI_FLY_UP_NEXT
	BIT			BitLeft,A
	JP			NZ,?HERO_AI_FLY_LEFT_NEXT
	BIT			BitRight,A
	JP			NZ,?HERO_AI_FLY_RIGHT_NEXT

	; MOVE
	;--------------------------------
	CALL		?HERO_CHECK_CURRENTS

	LD			A,(COLL_YMOVE)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	COLL_DETECT
	CHECK_HOTSPOT
	CALL		?CAMERA_UPDATE

	; CHECK LANDING
	;--------------------------------
	LD			A,(COLL_YDELTA)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	LD			A,(COLL_YMOVE)
	AND			A
	JP			NZ,?HERO_AI_CLOSE

	CALL		?HERO_GET_TILE_DOWN
	LD			A,(HL)

	CP			COLLCODE_JUMP
	JP			Z,?HERO_AI_CLOSE

	CP			COLLCODE_SPACE
	JP			NZ,_BOUNCE

	CALL		?HERO_FLY_COLL_CLOSE
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_SWIMEND_DOWN_ANIM
	JP			?HERO_AI_PUPPET

_BOUNCE
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_BOUNCY_DOWN_ANIM
	JP			?HERO_AI_CLOSE

;********************************
?HERO_AI_FLY_LEFT_START
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_LEFT_START_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_LEFT_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_LEFT
	CALL		?HERO_AI_OPEN

?HERO_AI_FLY_LEFT_NEXT
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_LEFT_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_LEFT_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_LEFT_STATE
	LD			A,%00000001
	LDFF_A		ACTOR_FLAGS
	CALL		?HERO_AI_OPEN
	CALL		?HERO_FLY_COLL_OPEN

	; CHECK DIRECTION
	;--------------------------------
	LD			A,(AI_CNTDOWN)

	BIT			BitRight,A
	JP			NZ,?HERO_AI_FLY_RIGHT_NEXT
	BIT			BitUp,A
	JP			NZ,?HERO_AI_FLY_UP_NEXT
	BIT			BitDown,A
	JP			NZ,?HERO_AI_FLY_DOWN_NEXT

	; MOVE
	;--------------------------------
	CALL		?HERO_CHECK_CURRENTS

	LD			A,(COLL_XMOVE)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	COLL_DETECT
	CHECK_HOTSPOT
	CALL		?CAMERA_UPDATE

	; CHECK LANDING
	;--------------------------------
	LD			A,(COLL_XDELTA)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	LD			A,(COLL_XMOVE)
	AND			A
	JP			NZ,?HERO_AI_CLOSE

	CALL		?HERO_GET_TILE_LEFT
	LD			A,(HL)

	CP			COLLCODE_JUMP
	JP			Z,?HERO_AI_CLOSE

	CP			COLLCODE_SPACE
	JP			NZ,_BOUNCE

	CALL		?HERO_FLY_COLL_CLOSE
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_SWIMEND_LEFT_ANIM
	JP			?HERO_AI_PUPPET

_BOUNCE
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_BOUNCY_LEFT_ANIM
	JP			?HERO_AI_CLOSE

;********************************
?HERO_AI_FLY_RIGHT_START
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_RIGHT_START_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_RIGHT_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_RIGHT
	CALL		?HERO_AI_OPEN

?HERO_AI_FLY_RIGHT_NEXT
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_RIGHT_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_RIGHT_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_RIGHT_STATE
	LD			A,%00000010
	LDFF_A		ACTOR_FLAGS
	CALL		?HERO_AI_OPEN
	CALL		?HERO_FLY_COLL_OPEN

	; CHECK DIRECTION
	;--------------------------------
	LD			A,(AI_CNTDOWN)

	BIT			BitLeft,A
	JP			NZ,?HERO_AI_FLY_LEFT_NEXT
	BIT			BitDown,A
	JP			NZ,?HERO_AI_FLY_DOWN_NEXT
	BIT			BitUp,A
	JP			NZ,?HERO_AI_FLY_UP_NEXT

	; MOVE
	;--------------------------------
	CALL		?HERO_CHECK_CURRENTS

	LD			A,(COLL_XMOVE)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	COLL_DETECT
	CHECK_HOTSPOT
	CALL		?CAMERA_UPDATE

	; CHECK LANDING
	;--------------------------------
	LD			A,(COLL_XDELTA)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	LD			A,(COLL_XMOVE)
	AND			A
	JP			NZ,?HERO_AI_CLOSE

	CALL		?HERO_GET_TILE_RIGHT
	LD			A,(HL)

	CP			COLLCODE_JUMP
	JP			Z,?HERO_AI_CLOSE

	CP			COLLCODE_SPACE
	JP			NZ,_BOUNCE

	CALL		?HERO_FLY_COLL_CLOSE
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_SWIMEND_RIGHT_ANIM
	JP			?HERO_AI_PUPPET

_BOUNCE
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_BOUNCY_RIGHT_ANIM
	JP			?HERO_AI_CLOSE

;********************************
?HERO_AI_FLY_UP_START
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_UP_START_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_UP_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_UP
	CALL		?HERO_AI_OPEN

?HERO_AI_FLY_UP_NEXT
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_FLY_UP_ANIM
	MOVADDR_FF	ACTOR_STATE,?HERO_AI_FLY_UP_STATE
	JP			?HERO_AI_CLOSE

?HERO_AI_FLY_UP_STATE
	LD			A,%00000000
	LDFF_A		ACTOR_FLAGS
	CALL		?HERO_AI_OPEN
	CALL		?HERO_FLY_COLL_OPEN

	; CHECK DIRECTION
	;--------------------------------
	LD			A,(AI_CNTDOWN)

	BIT			BitDown,A
	JP			NZ,?HERO_AI_FLY_DOWN_NEXT
	BIT			BitRight,A
	JP			NZ,?HERO_AI_FLY_RIGHT_NEXT
	BIT			BitLeft,A
	JP			NZ,?HERO_AI_FLY_LEFT_NEXT

	; MOVE
	;--------------------------------
	CALL		?HERO_CHECK_CURRENTS

	LD			A,(COLL_YMOVE)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	COLL_DETECT
	CHECK_HOTSPOT
	CALL		?CAMERA_UPDATE

	; CHECK LANDING
	;--------------------------------
	LD			A,(COLL_YDELTA)
	AND			A
	JP			Z,?HERO_AI_CLOSE

	LD			A,(COLL_YMOVE)
	AND			A
	JP			NZ,?HERO_AI_CLOSE

	CALL		?HERO_GET_TILE_UP
	LD			A,(HL)

	CP			COLLCODE_JUMP
	JP			Z,?HERO_AI_CLOSE

	CP			COLLCODE_SPACE
	JP			NZ,_BOUNCE

	CALL		?HERO_FLY_COLL_CLOSE
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_SWIMEND_UP_ANIM
	JP			?HERO_AI_PUPPET

_BOUNCE
	MOVADDR_FF	SCRIPT_WSTATE,?SCRIPT_START
	MOVADDR_FF	SCRIPT_WFRAME,?_HERO_BOUNCY_UP_ANIM
	JP			?HERO_AI_CLOSE

;********************************
	END
;********************************
